[buildout]
extensions = buildout.bootstrap
versions = versions
parts = 
    svn
    trac
    project

    trac-conf
    extra-conf

    source-download
    source-import

    recipe-xml
    trac-logo
    commit
    end

    pep8
    run-pep8
    run

    supervisor

    i_shouldnt_have_to_do_this

[svn]
recipe = plone.recipe.command
command = 
    svnadmin create ${svn:repo}
    svn mkdir -m ${svn:msg} file:///${svn:repo}/branches
    svn mkdir -m ${svn:msg} file:///${svn:repo}/tags
    svn mkdir -m ${svn:msg} file:///${svn:repo}/trunk
repo = ${buildout:directory}/repo
msg = "Initial import"
rev = 0

[trac]
recipe = zc.recipe.egg
# XXX Bitten not on PyPI, WTF?
find-links = http://ftp.edgewall.com/pub/bitten/Bitten-0.6b2.tar.gz
eggs = 
    Trac
    Bitten

[project]
recipe = plone.recipe.command
command = 
# XXX Is there no way to do a non-interactive initenv?
    ${buildout:bin-directory}/trac-admin project initenv
# Run me whenever buildout runs
update-command = ${project:command}

[versions]
# XXX Bitten does not support Trac 0.12, WTF?
Trac = 0.11.4

[hosts]
localhost = 127.0.0.1

[ports]
trac = 8080

[project]
# Trac project to initenv
name = project
path = ${buildout:directory}/${project:name}


[extra-conf]
recipe = plone.recipe.command
command = 
    ${buildout:bin-directory}/trac-admin ${project:path} upgrade
    ${buildout:bin-directory}/trac-admin ${project:path} permission add anonymous BUILD_VIEW
    ${buildout:bin-directory}/trac-admin ${project:path} permission add anonymous BUILD_EXEC
    ${buildout:bin-directory}/trac-admin ${project:path} permission add anonymous TRAC_ADMIN
# Run me whenever buildout runs
update-command = ${extra-conf:command}

[trac-logo]
recipe = plone.recipe.command
command = cp ${buildout:directory}/bitten_logo_small.png ${project:path}/htdocs

[source-download]
recipe = hexagonit.recipe.download
url = http://www.djangoproject.com/download/1.2.1/tarball/
strip-top-level-dir = true

[source-import]
recipe = plone.recipe.command
command = 
    cd ${source-download:location}
#    svn import -m ${svn:msg} . file:///${svn:repo}/trunk
    svn co file:///${svn:repo}/trunk .
    svn add *
    svn commit -m ${svn:msg}

[pep8]
recipe = zc.recipe.egg
interpreter = python

# Extra args
script = ${buildout:bin-directory}/pep8
ignore = '--ignore=E501'

[commit]
recipe = plone.recipe.command
command = 
    echo test >> ${source-download:location}/test
    svn add ${source-download:location}/test
    svn commit --force-log -m test ${source-download:location}/test
update-command = ${commit:command}

[trac-conf]
recipe = collective.recipe.template 
input = ${buildout:directory}/templates/trac.ini.in
output = ${project:path}/conf/trac.ini

[recipe-xml]
recipe = collective.recipe.template 
input = ${buildout:directory}/templates/recipe.xml.in
output = ${buildout:directory}/recipe.xml

[run-pep8]
recipe = collective.recipe.template 
input = ${buildout:directory}/templates/run_pep8.py.in
output = ${buildout:directory}/run_pep8.py

[run]
recipe = collective.recipe.template 
input = ${buildout:directory}/templates/run.sh.in
output = ${buildout:directory}/run.sh

[end]
recipe = plone.recipe.command
command =
    echo -------------------------------------------------------------------------------- 
    echo Bitten config
    echo -------------------------------------------------------------------------------- 
    cat ${buildout:directory}/recipe.xml

[supervisor]
recipe = collective.recipe.supervisor
programs = 
    00 tracd ${buildout:bin-directory}/tracd [ ${project:path} --port=${ports:trac} ]
    00 slave ${buildout:bin-directory}/bitten-slave [ -v http://${hosts:localhost}:${ports:trac}/${project:name}/builds ]

[i_shouldnt_have_to_do_this]
recipe = plone.recipe.command
command = 
    chmod 755 ${buildout:directory}/run.sh
update-command = ${i_shouldnt_have_to_do_this:command}
